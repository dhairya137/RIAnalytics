{% extends 'raw_base.html' %}

{% block content %}
  <div class="page-heading">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <div class="header-text">
            <h2>{{mode}}<span style="color: #ff511a;"> Analytics Report</span></h2>
            <div class="div-dec"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div  id='download_btn_div'>
    <div></div>"
    <div class="shadow-sm p-4 bg-white border d-flex flex-row justify-content-end align-items-center">
      <p>Download Files:</p>
      {% if mode == 'Text' or mode == 'Insights'%}
      {% for item in files %}
      <a class="bg-white p-3 shadow-sm m-1 text-warning rounded" href="http://localhost:8000/download/{{item}}" download>{{item}} </a>
      {% endfor %}
      {% endif %}
      <button class="bg-primary p-2 text-white rounded" onclick="getPDF()">Download Report</button>
    </div>
  </div>
  <div id='waiting' class='text-center mt-4 h4 text-warning'>
      <div class='p-4 m-4 col-12 d-flex justify-content-center align-items-center'>
        <div class='card shadow-lg col-sm-12 col-lg-6 p-4'>
          <div class='card-header text-left text-dark h6'>Status</div>
          <div class='card-body text-center'>
            <h1 style='color: #ff511a'>RI Analytics</h1>
            <p class='mt-2 mb-2'>Your {{mode}} report is being generated</p>
            <p class='mt-2 mb-2 samll text-dark'  id="status_box"></p>
            <div style='color: #ff511a' class='col-12 d-flex col-6 p-3 justify-content-center align-items-center'><div class='spinner-border'></div></div>
          </div>
        </div>
      </div>
  </div>
  <div  id='reload_btn_div'>
    <div class="p-4 d-flex justify-content-center">
      <button style='background-color: #ff511a;min-width:150px'  class=" p-4 text-white rounded" onclick="analyseText()">Retry</button>
    </div>
  </div>  
  <section class="about-us p-4" id= 'report_element'>  
    {{report|safe}}

    <div id='content' class='col-12'>
    
    </div>    
    <div class='text-center small col-12'>Report generated by RI Analytics</div>
  </section>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    var completed = false;
    var timer = null;
    
    function executeScriptElements(containerElement) {
        const scriptElements = containerElement.querySelectorAll("script");

        Array.from(scriptElements).forEach((scriptElement) => {
          const clonedElement = document.createElement("script");

          Array.from(scriptElement.attributes).forEach((attribute) => {
            clonedElement.setAttribute(attribute.name, attribute.value);
          });
          
          clonedElement.text = scriptElement.text;

          scriptElement.parentNode.replaceChild(clonedElement, scriptElement);
        });
      }
    function check(){
      let murl = "{{statusurl}}";
      let response = fetch(murl);
      try{
        response.then( response=> response.json().then(data=> {
          if (data.value == 'QUIT'){ clearInterval(timer);}
          else{document.getElementById('status_box').textContent = data.value;console.log(`${data.value}`)}
          attempts ++;
        }));
    }
    catch(error){alert(error);}

    }      
    function analyseText(){
      let url = "{{url}}";
      let response = fetch(url);
      timer = setInterval(check, 2000);
      document.getElementById('download_btn_div').style.display = "none";
      document.getElementById('reload_btn_div').style.display = "none";  
      try{
      response.then( response=> response.json().then(data=> {
          if (data.status == 'successful'){
            document.getElementById('content').innerHTML = data.report;
            executeScriptElements(document.getElementById('content'));
            document.getElementById('waiting').textContent = '';  
            document.getElementById('download_btn_div').style.display = "block"; 
            document.getElementById('reload_btn_div').style.display = "none"; 
            clearInterval(timer);
          }
          else{
            document.getElementById('content').innerHTML = '';
            document.getElementById('waiting').textContent = 'Analytics Failed'; 
            document.getElementById('reload_btn_div').style.display = "block";  
          };
          

        }));
    }
    catch(error){
      document.getElementById('content').innerHTML = '';
      document.getElementById('waiting').textContent = 'Analytics Failed'; 
      document.getElementById('reload_btn_div').style.display = "block"; 
    }

    }
    
    function getPDF(){
      var element = document.getElementById('report_element');
      var worker = html2pdf().from(element).save();
    }
    analyseText();
  </script>

  <p class="text-white" style="font-size: 18px;"></p>
            <p class="text-white"></p>

  <!-- ***** Main Banner Area End ***** -->
{% endblock %}